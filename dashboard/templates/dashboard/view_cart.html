<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Giỏ hàng</title>

    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        background-color: #f5f7fa;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 900px;
        margin: 60px auto;
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 25px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
      }

      th {
        background-color: #4f46e5;
        color: white;
      }

      tr:nth-child(even) {
        background-color: #f9fafb;
      }

      .empty {
        text-align: center;
        color: #666;
        margin-top: 20px;
      }

      .btn {
        display: inline-block;
        margin-top: 20px;
        padding: 10px 14px;
        background-color: #64748b;
        color: white;
        text-decoration: none;
        border-radius: 6px;
      }

      .btn:hover {
        background-color: #475569;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Giỏ hàng của bạn</h1>
      {% load humanize %} {% if cart_items %}
      <form method="post" action="{% url 'checkout_selected' %}">
        {% csrf_token %}

        <table>
          <thead>
            <tr>
              <th>Chọn</th>
              <th>#</th>
              <th>Tên sản phẩm</th>
              <th>Giá</th>
              <th>Số lượng</th>
              <th>Thành tiền</th>
              <th>Xóa</th>
            </tr>
          </thead>

          <tbody>
            {% for item in cart_items %}
            <tr>
              <!-- CHECKBOX -->
              <td>
                <input
                  type="checkbox"
                  name="selected_items"
                  value="{{ item.id }}"
                  class="pick"
                  data-subtotal="{{ item.subtotal|floatformat:0 }}"
                />
              </td>

              <td>{{ forloop.counter }}</td>
              <td>{{ item.product.product_name }}</td>
              <td>{{ item.product.price|floatformat:0|intcomma }} đ</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.subtotal|floatformat:0|intcomma }} đ</td>

              <!-- NÚT XÓA -->
              <td>
                <a
                  href="javascript:void(0);"
                  data-url="{% url 'remove_cart_item' item.id %}"
                  onclick="confirmDelete(this.dataset.url)"
                  style="color: red; cursor: pointer"
                >
                  xóa
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <h1>Tổng: <span id="totalSelected">0</span> đ</h1>
        <!-- NÚT THANH TOÁN LẺ -->
        <button type="submit" class="btn">Thanh toán sản phẩm đã chọn</button>
      </form>
      {% else %}
      <p class="empty">Giỏ hàng trống</p>
      {% endif %}

      <a href="{% url 'dashboard' %}" class="btn">← Quay về trang chủ</a>
    </div>
  </body>
  <script>
    function confirmDelete(deleteUrl) {
      Swal.fire({
        title: "Xác nhận xóa?",
        text: "Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng không?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Xóa",
        cancelButtonText: "Hủy",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = deleteUrl;
        }
      });
    }
    function formatVND(n) {
      // 1200000 -> "1,200,000"
      return (n || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function calcSelectedTotal() {
      let sum = 0;
      document.querySelectorAll("input.pick:checked").forEach((cb) => {
        const val = parseFloat(cb.dataset.subtotal || "0");
        if (!isNaN(val)) sum += val;
      });
      document.getElementById("totalSelected").textContent = formatVND(
        Math.round(sum)
      );
    }

    // Lắng nghe tick/untick
    document.addEventListener("change", function (e) {
      if (e.target && e.target.classList.contains("pick")) {
        calcSelectedTotal();
      }
    });

    // load lần đầu (nếu có checkbox được check sẵn)
    calcSelectedTotal();
  </script>
</html>
